generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Agent {
  id                  String        @id @default(cuid())
  name                String
  description         String?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  onChainId           String?       @unique
  walletAddress       String?       @unique
  moltbookApiKey      String?       @unique
  moltbookAgentName   String?
  moltbookClaimedAt   DateTime?
  confidenceThreshold Float         @default(0.75)
  maxTransactionValue BigInt?
  isActive            Boolean       @default(true)
  decisions           Decision[]
  executions          Execution[]
  memories            Memory[]
  observations        Observation[]

  @@index([walletAddress])
}

model Observation {
  id          String     @id @default(cuid())
  agentId     String
  createdAt   DateTime   @default(now())
  source      String
  chainId     Int?
  blockNumber BigInt?
  stateData   Json
  context     String?
  decisions   Decision[]
  agent       Agent      @relation(fields: [agentId], references: [id])

  @@index([agentId, createdAt])
  @@index([source])
}

model Decision {
  id            String         @id @default(cuid())
  agentId       String
  observationId String
  createdAt     DateTime       @default(now())
  action        String
  parameters    Json?
  confidence    Float
  reasoning     String
  status        DecisionStatus @default(PENDING)
  policyPassed  Boolean        @default(false)
  policyErrors  String[]
  agent         Agent          @relation(fields: [agentId], references: [id])
  observation   Observation    @relation(fields: [observationId], references: [id])
  execution     Execution?

  @@index([agentId, createdAt])
  @@index([status])
}

model Execution {
  id           String          @id @default(cuid())
  agentId      String
  decisionId   String          @unique
  createdAt    DateTime        @default(now())
  completedAt  DateTime?
  chainId      Int
  txHash       String?
  blockNumber  BigInt?
  gasUsed      BigInt?
  gasCost      BigInt?
  status       ExecutionStatus @default(PENDING)
  errorMessage String?
  success      Boolean?
  outcomeData  Json?
  agent        Agent           @relation(fields: [agentId], references: [id])
  decision     Decision        @relation(fields: [decisionId], references: [id])

  @@index([agentId, createdAt])
  @@index([txHash])
  @@index([status])
}

model Memory {
  id           String     @id @default(cuid())
  agentId      String
  createdAt    DateTime   @default(now())
  type         MemoryType
  content      String
  metadata     Json?
  embeddingId  String?    @unique
  importance   Float      @default(0.5)
  accessCount  Int        @default(0)
  lastAccessed DateTime?
  agent        Agent      @relation(fields: [agentId], references: [id])

  @@index([agentId, type])
  @@index([importance])
}

model PaymentRecord {
  id              String        @id @default(cuid())
  createdAt       DateTime      @default(now())
  paymentHash     String        @unique
  amount          BigInt
  currency        String
  chainId         Int
  requestedAction String
  requester       String
  status          PaymentStatus @default(PENDING)
  executionId     String?

  @@index([paymentHash])
  @@index([requester])
}

model ReputationAttestation {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  agentOnChainId  String
  attestor        String
  attestationType String
  score           Int
  metadata        Json?
  chainId         Int
  txHash          String?

  @@index([agentOnChainId])
  @@index([attestor])
}

model ProtocolSponsor {
  id                   String               @id @default(cuid())
  protocolId           String               @unique
  name                 String
  balanceUSD           Float                @default(0)
  totalSpent           Float                @default(0)
  sponsorshipCount     Int                  @default(0)
  whitelistedContracts String[]
  tier                 String               @default("bronze")
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  approvedAgents       ApprovedAgent[]
  deposits             DepositTransaction[]

  @@index([protocolId])
}

model DepositTransaction {
  id            String          @id @default(cuid())
  protocolId    String
  txHash        String          @unique
  amount        Float
  tokenAmount   BigInt
  tokenSymbol   String          @default("USDC")
  chainId       Int
  confirmed     Boolean         @default(false)
  blockNumber   BigInt?
  confirmedAt   DateTime?
  senderAddress String
  createdAt     DateTime        @default(now())
  protocol      ProtocolSponsor @relation(fields: [protocolId], references: [protocolId])

  @@index([protocolId])
  @@index([txHash])
  @@index([senderAddress])
  @@index([confirmed])
}

model ApprovedAgent {
  id             String          @id @default(cuid())
  protocolId     String
  agentAddress   String
  agentName      String?
  approvedBy     String
  approvedAt     DateTime        @default(now())
  revokedAt      DateTime?
  maxDailyBudget Float           @default(10)
  isActive       Boolean         @default(true)
  protocol       ProtocolSponsor @relation(fields: [protocolId], references: [protocolId])

  @@unique([protocolId, agentAddress])
  @@index([protocolId])
  @@index([agentAddress])
  @@index([isActive])
}

model SponsorshipRecord {
  id               String   @id @default(cuid())
  userAddress      String
  protocolId       String
  decisionHash     String   @unique
  estimatedCostUSD Float
  actualCostUSD    Float?
  txHash           String?
  signature        String
  ipfsCid          String?
  createdAt        DateTime @default(now())

  @@index([userAddress])
  @@index([protocolId])
  @@index([decisionHash])
}

// ============================================================================
// Agent Delegation Framework
// User-to-Agent delegation with scoped permissions and gas budgets
// ============================================================================

model Delegation {
  id             String           @id @default(cuid())
  delegator      String           // User wallet address (SCW)
  agent          String           // Agent wallet address
  agentOnChainId String?          // ERC-8004 agent ID (required if DELEGATION_REQUIRE_ERC8004=true)

  // Signature verification (EIP-712)
  signature      String           // EIP-712 signature from delegator
  signatureNonce BigInt           // Replay protection nonce

  // Permissions (JSON schema: contracts, functions, value limits, rate limits)
  permissions    Json             // DelegationPermissions

  // Budget (Wei) - separate from protocol budget
  gasBudgetWei   BigInt           // User-allocated gas budget
  gasBudgetSpent BigInt           @default(0)

  // Status and validity
  status         DelegationStatus @default(ACTIVE)
  validFrom      DateTime
  validUntil     DateTime
  revokedAt      DateTime?
  revokedReason  String?

  // On-chain reference (optional audit trail)
  onChainTxHash  String?

  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  // Relations
  usageRecords   DelegationUsage[]

  @@unique([delegator, agent, signatureNonce])
  @@index([delegator])
  @@index([agent])
  @@index([status, validUntil])
  @@index([agentOnChainId])
}

model DelegationUsage {
  id               String     @id @default(cuid())
  delegationId     String
  delegation       Delegation @relation(fields: [delegationId], references: [id])

  // Transaction details
  targetContract   String
  functionSelector String?
  valueWei         BigInt
  gasUsed          BigInt
  gasCostWei       BigInt

  // Result
  txHash           String?
  success          Boolean
  errorMessage     String?

  createdAt        DateTime   @default(now())

  @@index([delegationId, createdAt])
  @@index([txHash])
}

enum DelegationStatus {
  ACTIVE    // Valid and usable
  REVOKED   // User revoked
  EXPIRED   // Past validUntil
  EXHAUSTED // Budget depleted
}

enum DecisionStatus {
  PENDING
  APPROVED
  REJECTED
  EXECUTED
  FAILED
}

enum ExecutionStatus {
  PENDING
  SUBMITTED
  CONFIRMED
  FAILED
  REVERTED
}

enum MemoryType {
  OBSERVATION
  DECISION
  OUTCOME
  LEARNED_PATTERN
  USER_FEEDBACK
}

enum PaymentStatus {
  PENDING
  CONFIRMED
  EXECUTED
  REFUNDED
}
